"use strict";	
	
var StockDate = function() {
    moment.locale("cn", {
        weekdaysShort: ["周日", "周一", "周二", "周三", "周四", "周五", "周六"]
    }),
    $("#datetime").text(moment().format("YYYY/MM/DD ddd"))
},
StockUtil = {
    randomInt: function(min, max) {
        return Math.floor(Math.random() * (max - min + 1) + min)
    },
    endsWith: function(str, suffix) {
        return - 1 !== str.indexOf(suffix, str.length - suffix.length)
    },
    tmpl: function(t, d) {
        for (var p in d) t = t.replace(new RegExp("{" + p + "}", "g"), d[p]);
        return t
    }
},
StockStorage = function() {
    var _ss;
    simpleStorage.get("stocks") ? _ss = simpleStorage.get("stocks") : (_ss = {
        active: 0,
        list: [{
            code: "sh000001",
            fsid: "1000001",
            name: "上证指数"
        },
        {
            code: "sh601766",
            fsid: "60606285115622",
            name: "中国中车"
        },
        {
            code: "sh600030",
            fsid: "51784422287902",
            name: "中信证券"
        },
        {
            code: "sz300104",
            fsid: "63702957234376",
            name: "乐视网"
        }]
    },
    simpleStorage.set("stocks", _ss)),
    this.getList = function() {
        return _ss.list
    },
    this.getActive = function() {
        return _ss.list[_ss.active]
    },
    this.delActive = function() {
        _ss.list.splice(_ss.active, 1),
        _ss.active = 0,
        simpleStorage.set("stocks", _ss)
    },
    this.setActiveIndex = function(i) {
        _ss.active = i,
        simpleStorage.set("stocks", _ss)
    },
    this.addStock = function(s) {
        for (var si = -1,
        i = 0,
        l = _ss.list.length; l > i; i++) if (_ss.list[i].code === s.code) {
            si = i;
            break
        }
        if ( - 1 === si) {
            _ss.active = 0;
            var _ssLength = _ss.list.unshift(s);
            _ssLength > 15 && _ss.list.pop(),
            simpleStorage.set("stocks", _ss)
        } else this.setActiveIndex(si)
    }
},
StockChart = function(ec, sStorage) {
    var CHART_OPTION = {
        legend: {
            data: ["price"],
            show: !1
        },
        grid: {
            x: 40,
            y: 20,
            x2: 20,
            y2: 20
        },
        noDataLoadingOption: {
            text: "没有数据, 请稍后刷新.",
            effect: "dynamicLine"
        },
        tooltip: {
            trigger: "axis",
            showDelay: 0,
            axisPointer: {
                type: "shadow"
            },
            formatter: function(params) {
                return isNaN(params[0].value) ? moment.unix(params[0].name).format("HH:mm") : moment.unix(params[0].name).format("HH:mm") + "&nbsp;&nbsp;" + params[0].value / 1e3 + "元"
            }
        },
        xAxis: [{
            type: "category",
            boundaryGap: !1,
            splitLine: {
                show: !0,
                lineStyle: {
                    color: "#eee"
                }
            },
            axisLine: {
                show: !1
            },
            axisLabel: {
                interval: function(index, data) {
                    return 30 === moment.unix(data).minute() ? !0 : 0 === moment.unix(data).minute() && 13 !== moment.unix(data).hour() ? !0 : !1
                },
                formatter: function(value) {
                    return 11 === moment.unix(value).hour() && 30 === moment.unix(value).minute() ? "11:30/13:00": moment.unix(value).format("HH:mm")
                }
            },
            data: []
        }],
        yAxis: [{
            name: "价格(元)",
            type: "value",
            scale: !0,
            splitNumber: 10,
            splitLine: {
                show: !0,
                lineStyle: {
                    color: "#eee"
                }
            },
            axisLine: {
                show: !1
            },
            axisLabel: {
                formatter: function(value) {
                    return value / 1e3
                }
            }
        }],
        series: [{
            name: "price",
            type: "line",
            itemStyle: {
                normal: {
                    lineStyle: {
                        color: "#029ACF"
                    }
                }
            },
            smooth: !0,
            symbol: "none",
            data: [0],
            markLine: {
                data: [],
                clickable: !1,
                symbol: "none",
                itemStyle: {
                    normal: {
                        color: "#D9831F",
                        lineStyle: {
                            type: "dashed",
                            width: 1
                        },
                        label: {
                            show: !1
                        }
                    }
                }
            }
        }]
    };
    $(".tan-main").height(.618 * window.innerHeight);
    var $titleContainer = $("#stock-title-container"),
    $code = ($("#stock-title"), $("#stock-code")),
    $name = $("#stock-name"),
    $current = $("#stock-current"),
    $percentage = $("#stock-percentage"),
    $change = $("#stock-change"),
    $open = $("#stock-open"),
    $high = $("#stock-high"),
    $low = $("#stock-low"),
    $close = $("#stock-close"),
    $lastClose = $("#stock-last-close"),
    _current = 0,
    _chart = ec.init($("#stock-chart")[0]),
    _self = this;
    window.onresize = _chart.resize;
    for (var xData = [(new moment).hour(9).minute(30).second(0).unix()], i = 0; 120 > i; i++) xData[i + 1] = xData[i] + 60,
    xData[i + 121] = xData[i + 1] + 12600;
    CHART_OPTION.xAxis[0].data = xData,
    _chart.setOption(CHART_OPTION);
    var _update_title = function(data) {
        $current.removeClass(),
        $percentage.removeClass(),
        $change.removeClass(),
        data.diff < 0 ? ($titleContainer.removeClass("price-rise price-drop"), setTimeout(function() {
            $titleContainer.addClass("price-drop")
        },
        10)) : ($titleContainer.removeClass("price-rise price-drop"), setTimeout(function() {
            $titleContainer.addClass("price-rise")
        },
        10))
		if(data.change < 0)
		{
			$current.html("&darr; " + data.current).addClass("text-success");
			$percentage.text(data.percentage).addClass("text-success");
			$change.text(data.change).addClass("text-success");
			data.close && $close.text(data.close).addClass("text-success");
			document.title = "盘感网 - 投资者首财经门户，股票资讯，股票弹幕"+sStorage.getActive().name + " ↓" + data.current + " " + data.percentage;
		}
		else{
			if(data.change > 0) {
			$current.html("&uarr; " + data.current).addClass("text-danger");
			$percentage.text("+" + data.percentage).addClass("text-danger");
			$change.text("+" + data.change).addClass("text-danger");
			data.close && $close.text(data.close).addClass("text-danger");
			document.title = "盘感网 - 投资者首财经门户，股票资讯，股票弹幕"+sStorage.getActive().name + " ↑" + data.current + " +" + data.percentage;
			}
			else{$current.text(data.current);
			$percentage.text(data.percentage);
			$change.text(data.change);
			data.close && $close.text(data.close);
			document.title = "盘感网 - 投资者首财经门户，股票资讯，股票弹幕"+sStorage.getActive().name + " " + data.current + " " + data.percentage;
			}
		}
        //data.change < 0 ? (, , , , ) : ,
        $high.text(data.high),
        $low.text(data.low)
    },
    _update_chart = function(data) {
        if (data.ts > CHART_OPTION.xAxis[0].data[0] && data.ts < CHART_OPTION.xAxis[0].data[240]) {
            var _series = _chart.getSeries(),
            _pl = _series[0].data.length;
            data.ts < CHART_OPTION.xAxis[0].data[_pl - 1] ? _series[0].data[_pl - 1].value = 1e3 * data.current: (_series[0].data[_pl - 1].symbol && (_series[0].data[_pl - 1].symbol = "none"), _series[0].data.push({
                value: 1e3 * data.current,
                symbol: "circle"
            })),
            _self.changed ? _self.changed = !1 : _chart.setSeries(_series)
        }
    };
    this.changed = !1,
    this.update = function(data_str) {
        var _data = data_str.split(","),
        data = {
            open: parseFloat(_data[1]),
            lastClose: parseFloat(_data[2]),
            current: parseFloat(0 === parseFloat(_data[3]) ? _data[6] : _data[3]),
            high: parseFloat(_data[4]),
            low: parseFloat(_data[5]),
            change: 0,
            percentage: 0,
            ts: moment(_data[_data.length - 3] + " " + _data[_data.length - 2]).unix()
        };
        data.ts > CHART_OPTION.xAxis[0].data[240] && (data.close = data.current),
        0 !== data.current && (data.diff = data.current - _current, data.change = parseFloat((data.current - data.lastClose).toFixed(2)), 0 !== data.open ? data.percentage = parseFloat((100 * data.change / data.open).toFixed(2)) + "%": data.percentage = parseFloat((100 * data.change / data.lastClose).toFixed(2)) + "%"),
        _current = data.current,
        _update_title(data),
        _update_chart(data)
    },
    this.load = function() {
        _chart.showLoading({
            text: "正在载入, 请稍候...",
            effect: "whirling"
        });
        var sa = sStorage.getActive();
        $code.text(sa.code.slice( - 6)),
        $name.text(sa.name),
		
        $.getJSON("/pangan-pangan-getajax.html", {
            fsid: sa.fsid
        },
        function(rs) {
            var infoData = rs.info.data,
            stockData = {
                open: infoData.quote.open_price,
                lastClose: infoData.quote.last_price,
                current: infoData.quote.price,
                high: infoData.quote.highest_price,
                low: infoData.quote.lowest_price,
                change: infoData.quote.change,
                percentage: infoData.quote.change_ratio,
                diff: infoData.quote.change
            }; (moment().hour() >= 15 || moment().hour() < 9) && (stockData.close = stockData.current);
            var chartData = rs.chart.data;
            $lastClose.text(stockData.lastClose),
            $open.text(stockData.open),
            stockData.open < stockData.lastClose ? $open.addClass("text-success") : stockData.open > stockData.lastClose && $open.addClass("text-danger"),
            _update_title(stockData);
            var priceData = [];
            if (0 !== chartData.list.length) {
                priceData.push(1e3 * stockData.open);
                for (var i = 0,
                l = chartData.list.length - 1; l > i; i++)(chartData.list[i].time <= chartData.time_section[0].end || chartData.list[i].time > chartData.time_section[1].begin) && priceData.push(chartData.list[i].price)
            } else priceData.push(1e3 * stockData.current);
            var _series = _chart.getSeries();
            _series[0].data = priceData,
            _series[0].markLine.data = [[{
                xAxis: -1,
                yAxis: 1e3 * stockData.lastClose
            },
            {
                xAxis: 241,
                yAxis: 1e3 * stockData.lastClose
            }]],
            _chart.setSeries(_series, !0),
            _chart.hideLoading()
        })
    }
},
StockList = function(sTan, sChart, sStorage) {
    var $list = $("#stock-list"),
    $input = $("#stock-list-input"),
    $result = $("#stock-list-result"),
    $del = $("#stock-list-del"),
    _tmpl_list = '<a class="list-group-item{ac}" href="javascript:;" data-index={i}><span class="badge">{code}</span>{name}</a>',
    _tmpl_result = '<li class="{ac}"><a href="javascript:;" data-index={i}>{name} {code}</a></li>',
    _q = null,
    _sr = [],
    _sto = null,
    _self = this;
    this.load = function() {
        var si, ac, ss = sStorage.getList(),
        sa = sStorage.getActive();
        $list.empty();
        for (var i = 0,
        l = ss.length; l > i; i++) ac = "",
        sa.code === ss[i].code && (ac = " active"),
        si = StockUtil.tmpl(_tmpl_list, {
            ac: ac,
            i: i,
            name: ss[i].name,
            code: ss[i].code.slice( - 6)
        }),
        $list.append(si);
        sChart.load(),
        sTan.joinRoom()
    };
    var _select = function(index) {
        void 0 !== index && (sStorage.addStock(_sr[index]), _self.load(), _clean())
    },
    _clean = function() {
        setTimeout(function() {
            _q = null,
            $input.val(""),
            $result.hide()
        },
        10)
    },
    _search = function() {
        _sto && clearTimeout(_sto),
        _sto = setTimeout(function() {
            $.trim($input.val()) !== _q && (_q = $.trim($input.val()), _q ? $.getJSON("/search", {
                q: _q
            },
            function(rs) {
                var ss = JSON.parse(rs).data;
                _sr = [];
                for (var i = 0,
                l = ss.length; l > i; i++) 3 === ss[i].market_type && _sr.push({
                    code: ss[i].security_label + ss[i].code_name,
                    fsid: ss[i].security_id,
                    name: ss[i].sc_name
                });
                if ($result.empty(), _sr.length > 0) for (var ac, ii = 0,
                ll = _sr.length; ll > ii; ii++) ac = 0 === ii ? "active": "",
                $result.append(StockUtil.tmpl(_tmpl_result, {
                    ac: ac,
                    i: ii,
                    name: _sr[ii].name,
                    code: _sr[ii].code.slice( - 6)
                }));
                else $result.append(StockUtil.tmpl(_tmpl_result, {
                    ac: "disabled",
                    i: -1,
                    name: "无相关股票",
                    code: ""
                }));
                $result.show()
            }) : $result.hide())
        },
        200)
    },
    _move_up = function() {
        $result.children("li.active").length && ($result.children("li.active").prev().length ? $result.children("li.active").removeClass("active").prev().addClass("active") : ($result.children("li.active").removeClass("active"), $result.children("li").last().addClass("active")))
    },
    _move_down = function() {
        $result.children("li.active").length && ($result.children("li.active").next().length ? $result.children("li.active").removeClass("active").next().addClass("active") : ($result.children("li.active").removeClass("active"), $result.children("li").first().addClass("active")))
    },
    _select_search = function() {
        _q === $input.val() ? _select($result.children("li.active").children("a").data("index")) : _search()
    };
    $input.on("keyup",
    function(e) {
        switch (e.keyCode) {
        case 13:
            _select_search();
            break;
        case 8:
            _search();
            break;
        case 38:
            _move_up();
            break;
        case 40:
            _move_down()
        }
    }).on("keypress",
    function(e) {
        13 !== e.keyCode && _search()
    }).on("blur", _clean),
    $list.on("click", "a",
    function(e) {
        var $s = $(e.target);
        "SPAN" === $s.attr("tagName") && ($s = $s.parent("a")),
        $s.hasClass("active") || (sChart.changed = !0, sStorage.setActiveIndex($s.data("index")), sTan.joinRoom(), sChart.load(), $list.children("a").removeClass("active"), $s.addClass("active"))
    }),
    $result.on("click", "li > a",
    function(e) {
        _select(e.target.dataset.index)
    }),
    $del.on("click",
    function(e) {
        1 === sStorage.getList().length ? alert("至少要保留一只自选股票哦~") : confirm("确定要删除 [" + sStorage.getActive().name + "] 吗?") && (sStorage.delActive(), _self.load())
    })
},
StockTan = function(sChart, sStorage) {

	//$('#history_clear').parent().prepend('<a class="js_onlineusers"></a>');
	var socket = new WebSocket('ws://120.27.32.81:8080'); 
	//var socket = new WebSocket('ws://localhost:8080'); 
	// 存弹幕消息
	var danmu=new Array();
	var timestamp = (new Date()).valueOf();
	
	danmu = ["这些是什么鬼","颜色怎么调","好玩好玩","股市那么大，我想弹一弹","大家来报一下建仓价","哭晕在厕所","没事","涨涨涨","姐姐我心情很差","你押大还是押小","此股必将翻倍","就这样吧","一字板","买股票就是合法赌博","黑色星期五","卖卖卖","继续观望","去啊","快卖","明天跌","哈哈","使劲买啊","今天是不是被坑了","雪球雪球","抄底","还可以","不敢上","明天又是一堆股神在说他怎么样怎么样赚钱","涨吧，涨吧，涨他个把月","快买吧","噢耶","完了","OK，You can you up","钱钱钱","亏的钱都去哪了","一下跌停一下涨停， 好极端喔","跳大绳，唱大戏！好玩！","现在是一行在跟做空势力掰手腕，做多势力观望","明天会高开低走吗？"," 早市预测非常准确！下午大家见机行事吧！！","今天才赚19个点！","国家队可以慢慢撤了，这两天为了护盘也算是拼了老命了，","鼓掌","能说明什么？只能说明市场的极度不健康","现在却没有人呼吁股民保持理性了","早跑赔的少","不得不说李嘉诚很有眼光。","赶快抓住出逃的机会吧","执法部门已对恶意做空的机构和个人核查取证","膜拜","神算子！","神了！我真心给跪了！","应该把90%的股票都停了，剩下大盘股，包你天天红","小板凳","给跪了","啥时不拉垃圾股中石油就离底不远了，只要还拉特大垃圾中石油跌势就没完。","大神，以后如何操作","人才都是在民间，那些够屁砖家有个毛用","我预测大盘很多股票将连续无量涨停","主演","水军","来自未来的人，将历史书上的作为预言告知世人！","做广告S全家.","有本事跌多久 涨多久！恢复原样！","全线涨停2市都是绩优股","蓝筹股是定海神针，慢慢悠然上去才好","SB能不打广告么？","要么都涨停要么跌停","自己分批持仓，可不要满仓，万一跌了，还有补仓的机会","从哪看的跌多久 涨多久！恢复原样！","好了伤疤忘了疼","昨天割肉了吧","全是没用的P话","五穷六绝七翻身，股市开始报复性拉升了","希望温和反弹，逐步走出底部，如果像下跌这样反弹速率太大，行情将不会持久","。。。。。。。。。。。。。。。。。。。。","。。。","。。","。","!!!!!!!!!!","~~~~~~~~~~","那么多股停牌，涨停正常，目前持观望态度","肖铁如泥是宝剑，何况是削钢呢？可削错了地方把无辜的小散给废了","病来如山倒，病去如抽丝。市场恢复不会这么快的！！","还记得这波大跌之前的行情吗？跟现在很像。大跌，涨，大跌","我买的票票全部停牌","说高开低走的都是B","才1000W 太少了","见过千股涨停，见过千股跌停，还见过千股停牌，见过千股开盘涨停","如果一切可以重来 我将远离股市","梅雁吉祥的高管增持承诺，贻笑大方了，监事增持300股以上，哈","现在要做的就是买买买！！！","坚守阵地不要卖，享受抄底乐趣！","哪有钱再买","什么玩意","淡定","不接飞刀","现在要做的就是买买买！！！ 享受抄底乐趣！","日妈 狗日的 这次是最大的骗局","今天又被老婆弄了一个跌停板","都是傻逼么","是人都知道，小股散户多，蓝筹股没有投机价值","果然一帮菜鸟在炒股啊，券商也是大空头居然没人看出来","呵呵， 这市场不是好人玩的","再看看","靠","其实我们还是要对国家有信心","今天看着吧，高开低走也是可能的，不过收盘不会太差","不盘活小盘股，散户最终都套着，市场没流动资金，谁来买卖","我是空头","所有网站关于IPO发审暂停的新闻都打不开，何解？","不高开低开的话，还怕跌停呢","输打赢要","叼","低走有什么好？没钱补仓了！","亏50%了这么走？？？","再不涨点，怎么好继续坑人","玩唔起唔好玩","股票我感觉还没到底","不想玩了，能重来不","明天肯定高开高走，可能中午跌一下，但是很快会被拉起来的，要跌","我真的很适合炒股！","只是涨一点点","下跌正常，两融安全，严查做空，救市，是否该有人为此负责呢？","买啥爹啥","明天会更好","高开不是好事","可以打字？","当韭菜了","抄个毛底，还不晓得企稳没有","今天开始炒股，希望2万变20万","大家都是哪的啊","股市低开高走！","如再乱发IPO,坚决不玩了.","珍爱生命.远离股市","呵呵","小散的血汗被打水漂了，谁来负责？人为事件不是市场引起的。","↑","我朋友他爸亏了1000万，笑笑没事儿","明天 高开低走吗","买买买","把钱还我，不玩了","股市你们造吗，抄底？","O(∩_∩)O哈哈~","哎，早知道，当初买房子好了！妈的500万就剩不点了","股市要开始猛涨了很快！发财的机会来了啊，兄弟们","国家要出大招就股市了","明天肯定高开低走","看好国家未来，我要做多挣钱","赶紧买进，到底了快","炒股就是浪费生命，浪费金钱，远离股市！","明天中小盘股肯定涨，高开低走，适合高抛低吸","明天中小盘肯定再涨","明天一定涨","现在要做的就是买买买！！！ 坚守阵地不要卖，享受抄底乐趣！","国家队悄悄的走，做开又快速地来","赌徒","明天高开吗","明天会不会高开","谁知道呢？","明天会高开吗","当前要做的事情就是买入，不卖一股。","妈的 今天涨了一半都卖了","老百姓都死了","炒股就是自杀啊","我靠尼玛","上涨要有持续性！不然就真的没人信你了！","今天股市起稳了，希望2万变20万","2个涨停后还会调整","大的趋势没有改变","跌一个字","中国铝业是 国务院控股60元跌到3元，还怎么投资。国家带头杀","看吧，现涨停，然后快速下落","证券会要严格控制上市公司，跌不得低于发行价格否则退出市场。","俺读书少，啥是停牌啊？","此次暴跌是融资融券制度施行以来，正腐对股市的一个压力测试","实业兴国，投机成拙","救市不过是把风险暂时隐藏！","我希望每一个上市公司，不能跌破发行价格，这样股市不怕跌了。","掉","干嘛要救市呢，明知道股市有风险","什么时候才能回本？","股市在抽疯，人民在吐槽！","两个月以后看能不能回本","股市高低自己要有杆秤,贪婪是魔鬼.风险控制第一位.","中国银行下一步怎样操作","韭菜一茬一茬的割","奶奶的","看看"];
	socket.onopen = function(event) { 
		// 发送一个初始化消息
		_show('欢迎进入盘感网股票弹幕，www.pangan.cn。禁止许发布虚假信息。'); 
	};
	// 监听消息
	socket.onmessage = function(msg) { 
		//eval('var da='+msg.data);
		var data=eval('(' + msg.data + ')');
		if(data.content)
		{
			_show(data.content);
			timestamp = (new Date()).valueOf();
			var _color='#'+('00000'+(Math.random()*0x1000000<<0).toString(16)).slice(-6);
			$("#message_history").append("<li style='color:"+_color+";border:1px solid "+_color+"'>"+data.content+"</li>");
			
			 var scrollTop = $("#message_history")[0].scrollHeight; 
		
			 $("#message_history").scrollTop(scrollTop);  
			 
			 // if($('.js_onlineusers').html() != '当前在线人数：'+data.onlineusers){
				// $('.js_onlineusers').html('当前在线人数：'+data.onlineusers);
			 // }
		}
		
	}; 
	socket.onclose = function(event) { 
		console.log('Client notified socket has closed',event); 
	};
	//console.log(danmu.length);
	var danmued = new Array();
	var dmdcount;
	function dm(){
		var b = setInterval(function(){
			
			var nowtimestamp = (new Date()).valueOf();
			var sec = (nowtimestamp-timestamp)/1000;
			if(sec>=2){
				var dmcount = danmu.length+1; 
				var num = Math.floor(Math.random()*dmcount);
				
				if(num==0){ num=1;}
				
				var num1;
				for(var i=0;i<Math.floor(Math.random()*10);i++){
					num1 = Math.floor(Math.random()*dmcount);
					if(num1==0){ num1=1;}
					
					//dmdcount=danmued.length;
					if(!in_danmued(danmu[num1-1])){
						socket.send('content='+danmu[num1-1]); 
						//console.log(danmu[num1-1]);
					}
					//socket.send('content='+danmu[num1-1]); 
				}
				//dmdcount=danmued.length;
				// if(!in_danmued(danmu[num-1])){
					// socket.send('content='+danmu[num-1]); 
				// }
				//socket.send('content='+danmu[num-1]); 
			}
			if(danmu.length == danmued.length){
				danmued = [];
			}
		},500);
	}
	
	function in_danmued(str){
		dmdcount=danmued.length;
		for(var i=0;i<dmdcount;i++){
			if(danmued[i] == str){
				return true;
			}
		}
		danmued[dmdcount]=str;
		return false;
	}
	dm();
	
	
	var t1;
	var DANMU_MODES = [1, 2, 6, 4, 5];
	var BAD_WORDS = /(微信|打炮|小姐|包夜|全套|作弊|magnet|肛|性|我日|傻逼|sb|二逼|口交|艹|操|妈逼|mlgb|fuck|你妈|约炮|鸡巴|阳痿|早泄|不孕|不育|共产党|蛤|群|贷款|淘宝|天猫|com|cc|net|奸|视频|彩票|投注|c0m|写真|种子|微商|代理|菠菜|法轮功|代购)/i;
	var t0 = Date.now();
	var step = 1000;
	var cnt = 0;
	var REDS = [];
    for (var i = 128; 255 >= i; i++) REDS.push(i.toString(16) + "0000");
    var _send = function(e) {
        if (13 === e.keyCode) {
            var text = $input.val();
			var t1 = Date.now();
			
			if(text.length >0&&text.length <= 24 && !BAD_WORDS.test(text)&&(t1 - t0) > step)
			{
				t0 = t1;
				$input.val("")
				socket.send('content='+text); 
			}
            //text && (text.length >0&&text.length < 24 && !BAD_WORDS.test(text) && (cnt >= 3 && 8 > cnt ? step = 2e3: cnt >= 8 && 18 > cnt ? step = 3e3: cnt >= 18 && 24 === cnt && (cnt = 18, step += 500), t1 = Date.now(), t1 - t0 > step && ( t0 = t1, cnt++)), $input.val(""))
			//$.post("ajax.php", {content:text});
			
		}
    },
	_sendfrombuttom = function(e) {
			var text = $input.val();
			var t1 = Date.now();
			
			if(text.length >0&&text.length <= 24 && !BAD_WORDS.test(text)&&(t1 - t0) > step)
			{
				t0 = t1;
				$input.val("")
				socket.send('content='+text); 
			}
    },
    _show = function(t) {
        _cm.send({
            text: t,
            size: StockUtil.randomInt(20, 30),
			color:StockUtil.randomInt(0,16777215),
            dur: StockUtil.randomInt(5e3, 15e3),
            mode: StockUtil.randomInt(0, 10) > 8 ? DANMU_MODES[StockUtil.randomInt(3, 4)] : DANMU_MODES[StockUtil.randomInt(0, 2)]
        })
    };
     this.joinRoom = function() {
        //_io.emit("join", sStorage.getActive().code)
    };
	
    var _cm = new CommentManager($("#stock-chart")[0]);
    _cm.init(),
    _cm.start();
	
    var $input = $("#tan-input");
    $input.on("keyup", _send),
    $input.focus();
	$("#tan1tan").on("click", _sendfrombuttom);
},
start = function(ec) {
    var sStorage = (new StockDate, new StockStorage),
    sChart = new StockChart(ec, sStorage),
    sTan = new StockTan(sChart, sStorage),
	sList = new StockList(sTan, sChart, sStorage);
    sList.load()
	//getData("one");
};
$(function() {
    window._bd_share_config = {
        common: {
            bdText: "弹股 #弹股# #弹幕股票#",
            bdDesc: "当弹幕遇上股票",
            bdUrl: "http://www.pangan.cn",
            bdSign: "off"
        },
        share: []
    },
    require.config({
        paths: {
            echarts: "http://echarts.baidu.com/build/dist/"
        }
    }),
    require(["echarts", "echarts/chart/line"], start)
	
	$("#history_clear").click(function(){
		$("#message_history").empty();
	})
	
	
});


	